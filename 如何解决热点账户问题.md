
# 如何解决热点账户问题
## 热点账户是什么
### 定义
    单位时间内高并发余额更新的账户

### 特征
    高并发写访问量大：​​ 大量交易同时尝试修改该账户的余额。
    ​强一致性要求高：​​ 账户余额必须精确无误，每次更新都必须反映最新的、正确的值，不能出现脏读或不一致。
    ​单点资源争用：​​ 由于需要保证强一致性，通常需要对账户记录加锁（行锁/页锁），导致大量并发请求在该锁上排队等待，形成瓶颈。

### 账户余额更新与其它信息更新的区别

| 对比项 | 余额 | 姓名等信息 |
|-------|-------|-------|
| 触发频率 | 多业务场景，频繁写 | 通常仅账户拥有者更新|
| 数据类型 | 强状态依赖、连续性 | 静态描述性、幂等性  |
| 操作独立性| 非独立，依赖当前值| 独立，覆盖式写入 |
| 一致性要求| 高（事务型） | 低（元数据更新） |

### 记账流程
可以直观的感受下记账的流程：

![记账流程](/image/如何解决热点账户问题/记账流程.png "记账流程")

至少6个数据库操作，随着业务的不断扩展，事务内的逻辑会越来越长，整个事务内，账户，都拿着锁，通常能达到10+ms。高并发场景下，导致排队等待，后续交易延迟显著增加（尾部延迟放大）：

![锁等待](/image/如何解决热点账户问题/锁等待.png "锁等待")

## 热点账户常见场景

银行系统：

| 常见场景         | 账务处理                                                                                  |
|------------------|-------------------------------------------------------------------------------------------|
| 跨分行转账       | A 分行客户账户→A分行待清算账户→总行清算账户→B分行待清算账户→B分行客户账户                   |
| 跨行超级网银     | A银行： A银行用户账户→ 超级网银待清算账户<br>人行：银行A备付金账户 → 银行B备付金账户<br>B银行：银行B超级网银待清算账户 → B银行用户账户 |
| 利息计提         | 利息支出账户 → 应付利息账户                                                               |
| 企业批量代发工资 | 企业结算户 → 员工工资户                                                                   |
| ...              |                                                                                           |

支付系统：

| 常见场景             | 账务处理                                         |
|----------------------|--------------------------------------------------|
| 卡交易               | A用户账户 → openloop账户<br>B用户账户 → openloop账户 |
| 营销返现             | 营销账户 → A用户账户<br>营销账户 → B用户账户        |
| user plan收取手续费  | A用户账户 → 手续费账户<br>B用户账户 → 手续费账户     |
| 商户收款             | A用户账户 → 商户待结算账户<br>B用户账户 → 商户待结算账户 |
| 充值                 | 充值待清算账户 → A用户账户                        |
| 提现                 | A用户账户 → 提现待清算账户                        |
| ...                  | ...        


## 如何解决热点账户问题

### 分布式系统的CAP理论

CAP理论指在分布式系统中，无法同时保证一致性（Consistency）、可用性（Availability）、分区容错性（Partition Tolerance），最多只能同时满足其中的两项，该理论为分布式系统的工程实践提供了指导。

| 特征       | 举例说明                                                                 |
|------------|--------------------------------------------------------------------------|
| 一致性     | 所有节点对外表现出一致的读写结果。例如你写入了100元，所有节点立刻都读到100元 |
| 可用性     | 系统始终对请求做出响应，保证服务不中断。即使节点有故障，系统也能正常读写   |
| 分区容错性 | 系统能容忍节点之间出现网络分区（通信中断）的情况，并继续运作               |

### 热点账户的CSR方案

热点账户 =  高并发 + 强一致性 + 单点资源。

CSR方案指在热点账户的实践中，无法同时保证高并发（High Concurrency）、强一致性（Strong Consistency）、资源集中化（Resource Centralization），最多只能同时满足其中的两项。

| 特征       | 说明                                                         |
|------------|--------------------------------------------------------------|
| 高并发     | 系统能处理大量并发更新请求                                   |
| 强一致性   | 每次操作必须立即反映到账户，不能异步补偿，也不能乱序           |
| 资源集中化 | 账户余额数据集中在单一账户/数据库节点记录上管理               |

### 一致性

| 一致性模型   | 描述                                                                 | 例子                                                                 |
|--------------|----------------------------------------------------------------------|----------------------------------------------------------------------|
| 强一致性     | 所有节点在任意时刻看到的数据都是一致的                                 | 支付宝余额支付，一旦付款成功，必须在所有页面都立刻反映出来。           |
| 线性一致性   | 强一致性的一种实现，但强调操作必须符合全局时序，保证时间顺序和操作程序 | Zookeeper锁                                                          |
| 顺序一致性   | 操作顺序对所有节点一致，但不保证全局最新，只保证操作顺序               | 主从数据库复制                                                       |
| 因果一致性   | 保证因果相关的操作按顺序执行，不相关可乱序                             | 用户先做交易，后返现，必须保证顺序                                   |
| 最终一致性   | 数据最终会收敛为一致，但短时间内可能不同步                             | 用户做交易完后，返现延迟到账，但最终一定到账                         |
| 会话一致性   | 对于同一客户端，始终看到自己写入的最新值                               | 用户充值后立刻看到余额增加，但朋友查看 TA 的余额可能仍是旧值          |
| 弱一致性     | 不做任何强一致性保证，仅在某些条件下同步                               |                                                                      |

### 牺牲C（高并发）- 缓冲批量入账

需要发起方配合改造，主动调接口查询处理结果

![缓冲入账](/image/如何解决热点账户问题/缓冲入账.png "缓冲入账")

### 牺牲S（强一致性）-  异步入账

1. 最终一致性，用户看到“交易成功”，但账务层
未处理完，余额未更新
2. 热点账没处理完，不能销户
3. 出账，余额如何校验是否足够
4. 一旦返回“成功”，异常只能靠补偿及人工介入

![异步入账](/image/如何解决热点账户问题/异步入账.png "异步入账")

### 牺牲S（强一致性）- Redis + MySQL 异步双写

1. 最终一致性，数据异步更新，可能出现短暂
不一致
2. redis要保证高可用，否则余额缺失的风险
3. 对账，余额核查，确保流水与余额同步
4. mq同步余额要幂等控制
5. 并发高时 Lua 脚本执行成为瓶颈

![异步双写](/image/如何解决热点账户问题/异步双写.png "异步双写")

### 牺牲R（资源集中化）- 账户物理拆分

1.  一个逻辑账户拆分成多个物理子账户
2. 对外展示为单一逻辑账户，用户查询
余额时汇总所有子账户余额；子账户对用户透明，仅内部处理使用
3. 交易请求通过算法（如账户ID取模）路由到特定子账户，确保同一账户的请求均匀分布
4. ​调拨策略​：
   - 按需调拨​：缺多少从其他子账户调多少。
   - 均衡调拨​：调拨后使所有子账户余额接近平均。
   - 归集调拨​：定期将资金归集到少数子账户。
   - ​路由调拨​：优先选择余额充足的子账户路由交易
5. 客户看到的账单流水不连续，需额外加工屏蔽调拨记录，或基于子账户流水计算总余额

![账户物理拆分](/image/如何解决热点账户问题/账户物理拆分.png "账户物理拆分")

### 牺牲R（资源集中化）- 账户功能拆分

1.  针对不同的功能开立专项的账户
2.  分户独立承担借贷记账，单一分户透支不影响其他分户，分户之间的调拨对应实际的经济活动
3. 比如银行分层清算体系、集团多事业部独立核算账户

![账户功能拆分](/image/如何解决热点账户问题/账户功能拆分.png "账户功能拆分")

### 跨分行转账

| 牺牲对象          | 实施方案                                                                                                                             |
|-------------------|--------------------------------------------------------------------------------------------------------------------------------------|
| 牺牲 C（并发）     | 影响用户体验，业务场景不允许，不可行                                                                                                 |
| 牺牲 S（强一致性） | 采用最终一致性，局部异步记账，用户账实时记，总行清算账户定时汇总一次，可行                                                           |
| 牺牲 R（资源集中化） | 1. 按分行维度拆分不同的清算账户，每个一级分行对应一个分行清算账户<br>2. 按交易来源拆分，代发工资，线上支付等<br>3. 按渠道维度拆分，手机银行、柜面系统、网银等<br>4. 按产品维度，活期存款、定期存款、贷款发放等 |

### 企业代发工资

| 牺牲对象          | 实施方案                                      |
|-------------------|-----------------------------------------------|
| 牺牲 C（并发）     | 串行发放工资，用户无感知，可行                |
| 牺牲 S（强一致性） | 采用最终一致性，可行，出账业务，有实现难度    |
| 牺牲 R（资源集中化） | 可行，余额分散，没有最大效率化，需考虑补偿措施 |

### 卡交易

| 牺牲对象          | 实施方案                                                                 |
|-------------------|--------------------------------------------------------------------------|
| 牺牲 C（并发）     | 影响用户体验，不可行                                                   |
| 牺牲 S（强一致性） | 采用最终一致性，局部异步，用户账实时记，openloop账号步记                |
| 牺牲 R（资源集中化） | 可行，账户拆分，可按卡类型拆分，或者虚拟账户池（Hash分片）拆分，水平分片方式实现压力均衡 |

### 营销返现

| 牺牲对象          | 实施方案                                                                 |
|-------------------|--------------------------------------------------------------------------|
| 牺牲 C（并发）     | 可行，串行处理返现，需考虑吞吐量，太慢会影响用户体验                    |
| 牺牲 S（强一致性） | 可行，出账业务，需保证余额足够，有实现难度                              |
| 牺牲 R（资源集中化） | 可行，账户拆分，拆分成多个物理账户，水平分片方式实现压力均衡            |

### 我们的实现方案

总体思路：
   - 异步记账
   - 余额占用表的设计处理异步记账出账的资金风险

![余额占用表](/image/如何解决热点账户问题/余额占用表.png "余额占用表")

### 余额占用表使用原理

假设账户A账户余额为1000元，发生+100、+200、-100、-200、-300、-900的交易，余额占用表的记录如下：

| 账号   | 流水号   | 金额  | 逻辑时间戳 | 备注                                  |
|--------|----------|-------|------------|---------------------------------------|
| 账户A  | 00000001 | +100  | 1          | 入账，不用判断余额                    |
| 账户A  | 00000002 | +200  | 2          | 入账，不用判断余额                    |
| 账户A  | 00000003 | -100  | 3          | 100+200-100，余额足够                 |
| 账户A  | 00000004 | -200  | 4          | 100+200-100-200，余额足够             |
| 账户A  | 00000005 | -300  | 5          | 100+200-100-200-300+1000余额足够      |
| 账户A  | 00000006 | -900  | 6          | 余额不足                              |

### 实时交易流程

1. 为什么选择逻辑时间戳？
2. 入账的余额占用为什么放在事务内进行？
3. 优化后出账是否仍有瓶颈？

![异步入账实时交易流程](/image/如何解决热点账户问题/异步入账实时交易流程.png "异步入账实时交易流程")

### 流程优化后对比

| 优化前 | 优化后 |
|------|------|
| ![记账流程](/image/如何解决热点账户问题/记账流程.png "记账流程")| ![异步入账实时交易流程](/image/如何解决热点账户问题/异步入账实时交易流程.png "异步入账实时交易流程")|

### 定时任务流程

![定时任务流程](/image/如何解决热点账户问题/定时任务流程.png "定时任务流程")



### 总结

| 牺牲对象            | 说明                              | 实施方案                          | 适用场景                                                                                     |
|---------------------|-----------------------------------|-----------------------------------|----------------------------------------------------------------------------------------------|
| 牺牲 C（高并发）     | 优化业务流程，使其能够串行处理    | 1. 缓冲批量入账                   | 用户感知不敏感、但一致性要求极高的场景，比如系统内部账户清结算、跨系统间的账号同步、人工介入的账号操作、高价值账户操作引入审批流等 |
| 牺牲 S（强一致性）   | 采用最终一致性，允许延迟同步      | 1. 异步记账<br>2. redis+mysql双写 | 适合对一致性要求不高、允许短时间数据不一致的业务场景，例如内部账户、充值到账延迟、营销活动记账、积分类虚拟资产内记账等         |
| 牺牲 R（资源集中化） | 拆解成多个子账户/账本，多资源     | 1. 物理拆分<br>2. 按功能拆分      | 天然具备可拆分维度的场景，如不具备，则物理拆分，但有一定的复杂度，拆分后，出账业务的资金使用效率降低，需实现账户间资金调拨       |


## 优化方向

### 动态检测热点账户算法

| 算法               | 原理                                                                                     |
|--------------------|------------------------------------------------------------------------------------------|
| 滑动窗口计数法     | 将时间划分为固定窗口（如3秒），统计每个账户的请求频次，通过小项堆计算Top-K热点           |
| 锁竞争分析法       | 单账户上锁时长大于50ms，触发热点账户标记                                                 |
| 机器学习预测       | 根据当前时间段账户特征（交易频次、金额离散度），预测下一时间段交易量预测值，当预测值大于系统性能阈值，则提前标识为热点账户，同时可在拆分账户方案中，提前进行资金调拨 |